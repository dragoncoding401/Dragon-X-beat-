<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خطوات الحل | Dragon X</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">

    <!-- Icon -->
    <link rel="icon" href="icon.png">

    <!-- pdfMake -->
    <script src="./lib/pdfmaker/pdfmake.min.js"></script>
    <script src="./lib/pdfmaker/vfs_fonts.js"></script>
    


    <!-- Nerdamer -->
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.9.1/lib/browser/math.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/algebrite@1.4.0/dist/algebrite.bundle-for-browser.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #121212;
            color: white;
        }
        .step-card {
            background: linear-gradient(135deg, #1e1e1e 0%, #2a0a0a 100%);
            border-right: 4px solid #ff0000;
        }
        .step-number {
            background-color: #ff0000;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
        }
    </style>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-14BZZY3CE6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-14BZZY3CE6');
</script>
</head>
<body class="min-h-screen">

<!-- Navbar -->
<nav class="bg-black/50 backdrop-blur-md py-4 px-6 fixed w-full z-50">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-2 space-x-reverse">
            <i data-feather="code" class="text-red-500"></i>
            <span class="text-xl font-bold text-white">Dragon X (beta)</span>
        </div>

        <div class="hidden md:flex space-x-8 space-x-reverse">
            <a href="index.html" class="text-white hover:text-red-500 line">الرئيسية</a>
            <a href="equation-solver.html" class="text-white hover:text-red-500 line">حل المعادلات</a>
            <a href="solution-steps.html" class="text-red-500 font-bold line">خطوات الحل</a>
            <a href="about-us.html" class="text-white hover:text-red-500 line">عنّا</a>
            <a href="contact-us.html" class="text-white hover:text-red-500 line">تواصل معنا</a>
        </div>

        <button class="md:hidden text-white" id="mobile-menu-button">
            <i data-feather="menu"></i>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="md:hidden hidden bg-black/80 py-4 px-6" id="mobile-menu">
        <div class="flex flex-col space-y-4">
            <a href="index.html" class="text-white hover:text-red-500">الرئيسية</a>
            <a href="equation-solver.html" class="text-white hover:text-red-500">حل المعادلات</a>
            <a href="solution-steps.html" class="text-red-500 font-bold">خطوات الحل</a>
            <a href="about-us.html" class="text-white hover:text-red-500">عنّا</a>
            <a href="contact-us.html" class="text-white hover:text-red-500">تواصل معنا</a>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="min-h-screen pt-24 pb-16">
    <div class="container mx-auto px-6">
        <div class="max-w-4xl mx-auto">
            
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold" data-aos="fade-right">خطوات حل المعادلة</h1>
                <a onclick="window.history.back();" href="#" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg flex items-center transition duration-300" data-aos="fade-left">
                    رجوع
                    <i data-feather="arrow-right" class="ml-2"></i>
                </a>
            </div>

            <!-- Equation Info -->
            <div class="mb-6 bg-gray-800 rounded-xl p-6" data-aos="fade-up">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <i data-feather="info" class="text-red-500 mr-2"></i>
                    معلومات المعادلة
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-gray-400">المعادلة الأصلية:</p>
                        <p id="original-equation" class="font-bold"></p>
                    </div>
                    <div>
                        <p class="text-gray-400">نوع المعادلة:</p>
                        <p id="Equation-type" class="font-bold"></p>
                    </div>
                    <div>
                        <p class="text-gray-400">الحل النهائي:</p>
                        <div id="final-solution" class="font-bold"></div>
                    </div>
                </div>
            </div>

            <!-- Steps Container -->
            <div id="steps" class="space-y-4"></div>

            <!-- Actions -->
            <div class="mt-8 flex justify-center space-x-4 space-x-reverse" data-aos="fade-up">
                <button onclick="exportStepsPDF();" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg flex items-center transition duration-300">
                    حفظ كـ PDF
                    <i data-feather="download" class="ml-2"></i>
                </button>
                <a href="equation-solver.html" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg flex items-center transition duration-300">
                    حل معادلة جديدة
                    <i data-feather="plus" class="ml-2"></i>
                </a>
            </div>

        </div>
    </div>
</main>

<!-- Footer -->
<footer class="bg-black py-8">
    <div class="container mx-auto px-6">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="mb-6 md:mb-0">
                <div class="flex items-center space-x-2 space-x-reverse">
                    <i data-feather="code" class="text-red-500"></i>
                    <span class="text-xl font-bold text-white">Dragon Coding</span>
                </div>
                <p class="text-gray-500 mt-2">نحو تعليم رياضي أفضل</p>
            </div>
            <div class="flex space-x-6 space-x-reverse">
                <a href="https://dragon-coding-team-website.netlify.app/" target="_blank" class="text-gray-400 hover:text-red-500 text-2xl"><i class="fa-solid fa-globe"></i></a>
                <a href="https://discord.gg/9yubUP25" target="_blank" class="text-gray-400 hover:text-red-500 text-2xl"><i class="fa-brands fa-discord"></i></a>
                <a href="https://www.tiktok.com/@dragon_coding_team" target="_blank" class="text-gray-400 hover:text-red-500 text-2xl"><i class="fa-brands fa-tiktok"></i></a>
            </div>
        </div>
        <hr class="border-gray-800 my-6">
        <div class="text-center text-gray-500">
            <p>© 2025 Dragon Coding. جميع الحقوق محفوظة</p>
        </div>
    </div>
</footer>

<!-- Scripts -->
<script>
// ======== Initialize AOS Animation ========
AOS.init({ duration: 800, easing: 'ease-in-out', once: true });

// ======== Init Feather Icons ========
feather.replace();

// ======== Mobile Menu Toggle ========
const mobileMenuBtn = document.getElementById("mobile-menu-button");
const mobileMenu = document.getElementById("mobile-menu");

mobileMenuBtn.addEventListener("click", () => {
    mobileMenu.classList.toggle("hidden");
});

// ======== Fetch URL Parameters ========
const params = new URLSearchParams(window.location.search);
const equation = params.get("equcation");
const type = params.get("type");
const solutions = params.get("solution");

// ======== Display Equation Info ========
const originalEquationEl = document.getElementById('original-equation');
const equationTypeEl = document.getElementById('Equation-type');
const finalSolutionEl = document.getElementById('final-solution');

originalEquationEl.innerHTML = equation || "<span class='text-yellow-400'>لا يوجد</span>";
finalSolutionEl.innerHTML = solutions || "<span class='text-yellow-400'>لا يوجد</span>";
equationTypeEl.innerText = 
    type === "linear" ? "معادلة خطية" :
    type === "quadratic" ? "معادلة تربيعية" :
    "معادلة متعددة الحدود";

// ======== Parse Functions ========
function parseLinearEquation(eq) {
    eq = eq.replace(/\s+/g, "");
    const [lhs, rhs] = eq.split("=");
    const aMatch = lhs.match(/([+-]?\d*)x/);
    const a = aMatch ? (aMatch[1]===""||aMatch[1]==="+"?1:(aMatch[1]==="-"?-1:parseFloat(aMatch[1]))) : 0;
    const bMatch = lhs.match(/([+-]\d+)(?!.*x)/);
    const b = bMatch ? parseFloat(bMatch[1]) : 0;
    const c = rhs ? parseFloat(rhs) : 0;
    return { a,b,c };
}

function parseQuadraticEquation(eq) {
    eq = eq.replace(/\s+/g, "");
    let [lhs,rhs] = eq.split("=");
    rhs = rhs || "0";
    const fullExpr = lhs + "-(" + rhs + ")";
    const aMatch = fullExpr.match(/([+-]?\d*)x\^2/);
    const bMatch = fullExpr.match(/([+-]?\d*)x(?!\^)/);
    const cMatch = fullExpr.match(/([+-]?\d+)(?!.*x)/);
    const a = aMatch ? (aMatch[1]===""||aMatch[1]==="+"?1:(aMatch[1]==="-"?-1:parseFloat(aMatch[1]))) : 0;
    const b = bMatch ? (bMatch[1]===""||bMatch[1]==="+"?1:(bMatch[1]==="-"?-1:parseFloat(bMatch[1]))) : 0;
    const c = cMatch ? parseFloat(cMatch[1]) : 0;
    return { a,b,c };
}

function parsePolynomialEquation(eq) { return { expression: eq }; }

// ======== Linear Steps ========
function solveLinearSteps(a,b,c) {
    return [
        { title:`طرح ${b} من الطرفين`, before:`${a}x + ${b} - ${b} = ${c} - ${b}`, after:`${a}x = <span class='text-green-400 font-bold'>${c-b}</span>` },
        { title:`قسمة الطرفين على ${a}`, before:`${a}x / ${a} = ${(c-b)}/${a}`, after:`x = <span class='text-green-400 font-bold'>${(c-b)/a}</span>` },
        { title:"التحقق من الحل", before:`${a}(${(c-b)/a}) + ${b} = ${c}`, after:`${c} = ${c} ✔️`}
    ];
}

// ======== Quadratic Steps ========
function solveQuadraticSteps(a,b,c) {
    const steps = [];
    steps.push({ title:"تحديد المعاملات", before:"", after:`a=${a} , b=${b} , c=${c}` });
    const delta = b*b - 4*a*c;
    steps.push({ title:"حساب Δ", before:"Δ = b² - 4ac", after:`Δ = ${delta}` });
    if(delta<0) {
        steps.push({ title:"لا يوجد حلول حقيقية", before:"", after:"لأن Δ < 0" });
    } else {
        const sqrtDelta = Math.sqrt(delta);
        const denom = 2*a;
        const x1 = (-b + sqrtDelta)/denom;
        const x2 = (-b - sqrtDelta)/denom;
        steps.push({ title:"تطبيق القانون العام", before:"x = (-b ± √Δ)/(2a)", after:`x₁=<span class='text-green-400 font-bold'>${x1}</span> , x₂=<span class='text-green-400 font-bold'>${x2}</span>` });
    }
    return steps;
}

// ======== Polynomial Steps ========
function solvePolynomialSteps(expression) {
    const steps = [];
    steps.push({ title:"كتابة المعادلة", before:"", after:expression });

    try {
        // حذف أي "=0"
        const expr = expression.replace(/\s*=\s*0\s*$/, "");

        // تحليل كثير الحدود
        steps.push({ title:"تحليل المعادلة إلى عوامل", before:expression, after:Algebrite.factor(expr).toString() });

        // حساب الجذور
        const rootsRaw = Algebrite.roots(expr).toString();
        const roots = rootsRaw.split(',').map(r => `<span class='text-green-400 font-bold'>${r}</span>`).join("<br>");

        steps.push({ title:"إيجاد الجذور", before:"", after:roots });

    } catch(e) {
        steps.push({ title:"خطأ", before:"", after:"فشل في تحليل المعادلة: " + e.message });
    }

    return steps;
}

// ======== Display Steps ========
function displaySteps(equation,type) {
    let steps = [];
    if(type==="linear") steps = solveLinearSteps(...Object.values(parseLinearEquation(equation)));
    else if(type==="quadratic") steps = solveQuadraticSteps(...Object.values(parseQuadraticEquation(equation)));
    else if(type==="polynomial") steps = solvePolynomialSteps(parsePolynomialEquation(equation).expression);
    else steps = [{ title:"خطأ", before:"", after:"<span class='text-red-600'>نوع المعادلة غير معروف</span>" }];

    const container = document.getElementById("steps");
    container.innerHTML = "";
    steps.forEach((s,i)=>{
        container.innerHTML += `
        <div class="step-card rounded-xl p-6 mb-4" data-aos="fade-up" data-aos-delay="${(i+1)*100}">
            <div class="flex items-start space-x-4 space-x-reverse">
                <div class="step-number">${i+1}</div>
                <div>
                    <h3 class="text-xl font-bold mb-2">${s.title}</h3>
                    ${s.before ? `<p class="text-gray-300 mb-2">${s.before}</p>` : ""}
                    ${s.after ? `<p class="text-gray-300">${s.after}</p>` : ""}
                </div>
            </div>
        </div>`;
    });
}

// Exporting Arabic fonts
pdfMake.fonts = {
    Cairo: {
        normal: 'Cairo-Regular.ttf',
        bold: 'Cairo-Bold.ttf',
    }
};

// A function that reverses the order of words, not letters
function fixArabicText(str) {
    if (!str) return "";

    // Text segmentation: (Arabic) | (Decimals) | (Numbers) | (Symbols) | (English)
    const parts = str.match(/[\u0600-\u06FF]+|[-+]?\d+(\.\d+)?|[:=+\-*/().]+|[a-zA-Z]+/g);

    if (!parts) return str;

    // Reverse only the order of parts (words/numbers/symbols stay intact)
    return parts.reverse().join(" ");
}

function exportStepsPDF() {
    const container = document.getElementById("steps");
    const stepCards = container.querySelectorAll(".step-card");

    if (stepCards.length === 0) return alert("لا توجد خطوات لتصديرها!");

    const stepsContent = [];

    stepCards.forEach((card, i) => {
        const titleEl = card.querySelector("h3");
        const beforeEl = card.querySelector("p:nth-of-type(1)");
        const afterEl = card.querySelector("p:nth-of-type(2)");

        const title = titleEl ? titleEl.innerText : `الخطوة ${i+1}`;
        const before = beforeEl ? beforeEl.innerText : "";
        const after = afterEl ? afterEl.innerText : "";

        stepsContent.push({
            stack: [
                { text: fixArabicText(`الخطوة ${i+1}: ${title}`), style: "stepTitle" },
                before ? { text: fixArabicText(`قبل: ${before}`), style: "stepBefore" } : {},
                after ? { text: fixArabicText(`بعد: ${after}`), style: "stepAfter" } : {}
            ],
            margin: [0, 10, 0, 10],
            style: "stepCard"
        });
    });

    const docDefinition = {
        content: [
            { text: fixArabicText("خطوات حل المعادلة"), style: "header", alignment: "center", margin: [0, 0, 0, 20] },
            { text: fixArabicText(`المعادلة: ${equation || "غير متوفرة"}`), style: "field" },
            { text: fixArabicText(`نوع المعادلة: ${type === "linear" ? "خطية" : type === "quadratic" ? "تربيعية" : "متعددة الحدود"}`), style: "field", margin: [0, 0, 0, 15] },
            ...stepsContent
        ],
        defaultStyle: {
            font: "Cairo",
            alignment: "right",
        },
        styles: {
            header: { fontSize: 24, bold: true, color: "#e63946", alignment: "center" },
            field: { fontSize: 16, margin: [0, 5, 0, 10], color: "#1d3557" },
            stepCard: { 
                margin: [0, 10, 0, 10], 
                fontSize: 14, 
                color: "#333",
                decorationColor: "#eee",
                fillColor: "#f8f9fa",
                border: [true, true, true, true],
                borderColor: "#dee2e6",
                borderRadius: 6
            },
            stepTitle: { fontSize: 16, bold: true, color: "#2b2d42", margin: [0, 0, 0, 5] },
            stepBefore: { fontSize: 14, color: "#6c757d", margin: [0, 0, 0, 3] },
            stepAfter: { fontSize: 14, bold: true, color: "#1d3557" }
        },
        pageMargins: [50, 60, 50, 60],
        pageOrientation: "portrait"
    };

    pdfMake.createPdf(docDefinition).download("خطوات_حل_المعادلة.pdf");
}

// ======== Initialize Steps ========
displaySteps(equation,type);
</script>
</body>
</html>